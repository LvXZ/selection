<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">

    <link rel="shortcut icon" href="../static/images/logo.ico" th:href="@{images/logo.ico}" type="image/x-icon"/>
    <link rel="stylesheet" href="../static/resources/materialize/css/materialize.css" media="screen,projection" th:href="@{resources/materialize/css/materialize.css}">
    <link rel="stylesheet" type="text/css" href="../static/css/login.css" th:href="@{css/login.css}">
    <link rel="stylesheet" type="text/css" href="../static/css/index.css" th:href="@{css/index.css}">
    <script src="../static/js/constant.js" th:src="@{js/constant.js}"></script>


    <!--<link rel="stylesheet" href="webjars/bootstrap/3.3.7/css/bootstrap.min.css" />
    <script src="webjars/jquery/3.1.1/jquery.min.js"></script>
    <script src="webjars/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->


    <link rel="stylesheet" type="text/css" href="../static/resources/bootstrap-3.3.7/css/bootstrap.min.css" th:href="@{resources/bootstrap-3.3.7/css/bootstrap.min.css}">
    <script src="../static/js/jquery-3.2.1.min.js" th:src="@{js/jquery-3.2.1.min.js}"></script>
    <script src="../static/resources/bootstrap-3.3.7/js/bootstrap.min.js" th:src="@{resources/bootstrap-3.3.7/js/bootstrap.min.js}"></script>

    <script src="../static/js/js.cookie.js" th:src="@{js/js.cookie.js}"></script>

    <title>教师界面</title>
</head>

<body onload="jumpLogin()" style="background-color:#39221e">

<div class="container">
    <div class="row clearfix">
        <div class="col-md-4 column pull-left" id="logo-title">
            <h1>
                老师管理界面
            </h1>
        </div>

    </div>
    <div class="row clearfix">
        <div class="col-md-12 column">
            <ul class="nav nav-pills">
                <li>
                    <a href="/lvxz/index_teacher">首页</a>
                </li>
                <li>
                    <a href="/lvxz/apply_teacher">毕业设计管理</a>
                </li>
                <li class="active">
                    <a href="#">学生申请管理</a>
                </li>
                <li class="dropdown pull-right">
                    <input id="user_name" value="未登录" readonly="true"/>
                </li>
                <li class="dropdown pull-right">
                    <input id="user_id" value="" readonly="true"/>
                </li>
                <li class="dropdown pull-right disabled">
                    <a href="#"></a>
                </li>
                <li class="dropdown pull-right">
                    <a href="#" data-toggle="dropdown" class="dropdown-toggle">个人设置<strong class="caret"></strong></a>
                    <ul class="dropdown-menu">
                        <li>
                            <a onclick="showTeacherInfo()">修改信息</a>
                        </li>
                        <li>
                            <a onclick="showTeacherPassword()">修改密码</a>
                        </li>
                        <li class="divider">
                        </li>
                        <li>
                            <a onclick="showDeleteCookies()">退出登录</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <div class="row clearfix">
        <div class="col-md-12 column">

            <div class="login-box-body">
                <ddd>



                </ddd>
            </div>



            <!--修改个人信息框-->
            <div class="modal fade" id="modal-container-287888" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" >
                <div class="modal-dialog" role="document">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h3 class="modal-title">
                            信息修改
                        </h3>
                    </div>

                    <div class="modal-body">
                        <div class="login-box-body">

                            <div class="input">
                                <input  class="form-control" id="update_InfoId" type="text" value="未登录" readonly="true"/>
                            </div>
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                                <input class="form-control" id="birthday" type="date" placeholder="出生日期"/>
                            </div>

                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-earphone"></i></span>
                                <input  class="form-control" id="phone" type="number" placeholder="手机"/>
                            </div>
                            <div class="input-group">
                                <span class="input-group-addon"><i class="iconfont">&#xe630;</i></span>
                                <input  class="form-control" id="qq" type="number" placeholder="QQ"/>
                            </div>

                            <div class="input" style="text-align:center">
                                <button class="btn btn-default btn-center" data-dismiss="modal">取消</button>
                                <button class="btn btn-primary btn-center" onclick="updateTeacherInfo()">修改</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--修改密码框-->
            <div class="modal fade" id="modal-container-287808" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" >
                <div class="modal-dialog" role="document">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h3 class="modal-title">
                            密码修改
                        </h3>
                    </div>

                    <div class="modal-body">
                        <div class="login-box-body">

                            <div class="input">
                                <input  class="form-control" id="update_PasswordId" type="text" value="未登录" readonly="true"/>
                            </div>

                            <div class="input-group">
                                <span class="input-group-addon"><i class="iconfont">&#xe62f;</i></span>
                                <input class="form-control" id="old_password" type="password" placeholder="旧密码"/>
                            </div>
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
                                <input  class="form-control" id="new_password" type="password" placeholder="新密码"/>
                            </div>

                            <div class="input" style="text-align:center">
                                <button class="btn btn-default btn-center" data-dismiss="modal">取消</button>
                                <button class="btn btn-primary btn-center" onclick="updateTeacherPassword()">修改</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!--留言信息框-->
            <div class="modal fade" id="modal-container-454545" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" >
                <div class="modal-dialog" role="document">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        <h3 class="modal-title">
                            留言
                        </h3>
                    </div>

                    <div class="modal-body">

                        <input  class="form-control" id="studentID" type="hidden" value="">

                        <bbbb>


                        </bbbb>
                    </div>

                    <div class="modal-footer">
                        <div class="login-box-body">
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-edit"></i></span>
                                <input class="form-control" id="words" type="text" placeholder="请输入..."/>
                                <span class="input-group-addon" style="background-color: #337ab7;border: 3px;">
                                    <button onclick="chatWithTeacher()" style="background-color: #337ab7;border: none;">发送</button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>
</div>


</body>

<script>

    /*网页生成时，验证是否登录的跳传*/
    function jumpLogin() {

        if(!Cookies.get('teacher_ObjJson')){
            alert("您还未登陆！请登陆");
            window.open("/lvxz/login",'_self');
        }else{
            var jsonValue = JSON.parse(Cookies.get('teacher_ObjJson'));
            getUser(jsonValue);

            getStudentApplyProjectInfo();
        }

    }

    <!-- 获取登录信息，并修改登录栏-->
    function getUser(jsonValue){
        $('#user_name').val(jsonValue.teacherName);
        $('#user_id').val(jsonValue.teacherID);
    }


    /*修改个人信息框出现*/
    function showTeacherInfo() {
        $('#update_InfoId').val($('#user_id').val()+"   "+$('#user_name').val());
        $('#modal-container-287888').modal('show');
    }

    /*修改个人信息函数*/
    function updateTeacherInfo() {

        var teacherID = $('#user_id').val();
        var birthday = $('#birthday').val();
        var phone = $('#phone').val();
        var qq = $('#qq').val();

        if(teacherID.length!=0){

            var updatePasswordURL = "/lvxz/teacher/update_info";
            var objJson = {
                "teacherID":parseInt(teacherID),
                "birthday":birthday,
                "phone":phone,
                "teacherQQ":qq,
            };

            $.ajax({
                type:"POST",
                url: updatePasswordURL,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                data: JSON.stringify(objJson),
                async:true,
                success: function (response) {
                    if(response.code == 1){
                        alert(response.msg);
                        location.reload();//重新加载
                    } else {
                        alert(response.msg);
                    }
                },
                error: function (data){
                    alert("访问失败，请检查网络、路径......");
                }
            });

        } else {
            alert("未登录！");
        }
    }

    /*修改密码框出现*/
    function showTeacherPassword(){
        $('#update_PasswordId').val($('#user_id').val()+"   "+$('#user_name').val());
        $('#modal-container-287808').modal('show');
    }

    /*修改密码函数*/
    function updateTeacherPassword(){

        var teacherID = $('#user_id').val();
        var oldPassword = $('#old_password').val();
        var newPassword = $('#new_password').val();

        if(teacherID.length!=0  && oldPassword.length!=0 && newPassword.length!=0) {

            var updatePasswordURL = "/lvxz/teacher/update_password";

            var objJson = {
                "teacherID":parseInt(teacherID),
                "password":oldPassword,
                "new_password":newPassword
            };

            $.ajax({
                type:"POST",
                url: updatePasswordURL,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                data: JSON.stringify(objJson),
                async:true,
                success: function (response) {
                    if(response.code == 1){
                        alert(response.msg);
                        location.reload();//重新加载
                    } else {
                        alert(response.msg);
                    }
                },
                error: function (data){
                    alert("访问失败，请检查网络、路径......");
                }
            });

        } else {
            alert("存在输入为空！");
        }
    }

    /*提示出现退出*/
    function showDeleteCookies() {
        if(confirm("您确定退出！")) {
            deleteCookies();
        }else{

        }
    }

    /*退出登录，消除cookies*/
    function deleteCookies() {
        Cookies.remove('teacher_ObjJson', { path: '' });
        window.open("/lvxz/login",'_self');
        alert("已注销");
    }


    $(function () { $("[data-toggle='tooltip']").tooltip('show'); });



    <!-- 获取文件下载url，下载-->
    function Start_Download(obj) {

        var fileURL = obj.id;
        var fileName = obj.name;
        var newURL = "http://"+ getLocalIP() +":8081/download/" + fileURL + fileName;
        console.log(newURL);

        $("[data-toggle='popover']").popover();

        var a = document.createElement('a');
        a.setAttribute('href', newURL);
        a.setAttribute('download', fileName);
        a.click();
        //设置时间关闭popover
        setTimeout(function(){$("[data-toggle='popover']").popover('hide');},3500);
    }



    <!-- 生成学生申请毕设的表格-->
    function getTable_Info(data){

        var $table=$('<table class="table table-bordered  table-condensed" id="table_design"></table>');
        $("ddd").append($table);

        var $thead=$('<thead></thead>');
        var $trs=$('<tr class="info"></tr>');

        var $th1=$('<th>毕设编码</th>');
        var $th2=$('<th>毕设名称</th>');
        var $th3=$('<th>管理状态</th>');
        var $th4=$('<th>学生申请时间</th>');
        var $th5=$('<th>留言</th>');
        var $th6=$('<th>学生姓名</th>');
        var $th7=$('<th>学生毕设状态</th>');
        var $th8=$('<th>操作</th>');
        var $th9=$('<th>文件名称</th>');
        var $th10=$('<th>最近修改时间</th>');
        var $tbody=$('<tbody></tbody>');

        $trs.append($th1);
        $trs.append($th2);
        $trs.append($th3);
        $trs.append($th4);
        $trs.append($th5);
        $trs.append($th6);
        $trs.append($th7);
        $trs.append($th8);
        $trs.append($th9);
        $trs.append($th10);

        $thead.append($trs);
        $table.append($thead);
        $table.append($tbody);

        var count = 0;//表格颜色控制
        for(var i=0;i<data.length;i++){

            if(count%2==0){
                var $tr=$('<tr></tr>');
            }else{
                var $tr=$('<tr class="success"></tr>');
            }
            $table.append($tr);

            var $td1=$('<td>'+data[i]['project']['designID']+'</td>');
            $tr.append($td1);
            var $td2=$('<td>'+data[i]['designName']+'</td>');
            $tr.append($td2);

            var $td3;
            switch(data[i]['designStatus']) {
                case 2:{
                    $td3=$('<td>等待申请</td>');
                }break;

                case 3:{
                    $td3=$('<td>申请截止</td>');
                }break;

                case 4:{
                    $td3=$('<td>项目完结</td>');
                }break;
            }
            $tr.append($td3);

            var d = new Date(data[i]['project']['createTime']);
            var times=d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
            var $td4=$('<td>'+times+'</td>');
            $tr.append($td4);

            var $td5=$('<td><button onclick="showChat(this)" class="btn btn-small btn-primary" name="'+ data[i]['project']['studentID'] +'"><i class="glyphicon glyphicon-comment"></i></button></td>');
            $tr.append($td5);

            var $td6=$('<td>'+data[i]['teacherName']+'</td>');
            $tr.append($td6);


            var $td7;
            var $td8;

            switch(data[i]['project']['enableStatus']){

                case -1:{
                    //被驳回
                    $td7=$('<td>申请被驳回</td>');
                    $td8=$('<td><button id="'+ data[i]['project']['projectID'] +'"  onclick="ensure_project(this);" type="submit" class="btn btn-small btn-warning">' +
                        '<i class="glyphicon glyphicon-remove">重新确定</i></button></td>');
                }break;

                case 0:{
                    //等待申请通过
                    $td7=$('<td>等待申请通过</td>');
                    $td8=$('<td>' +
                                '<button id="'+ data[i]['project']['projectID'] +'" type="button" class="btn btn-small btn-warning" data-toggle="tooltip"' +
                                        'data-placement="left" title="驳回申请" onclick="oppose_project(this);">' +
                                        '<i class="glyphicon glyphicon-remove"></i>' +
                                '</button>&nbsp;' +
                                '<button id="'+ data[i]['project']['projectID'] +'" type="button" class="btn btn-small btn-warning" data-toggle="tooltip"' +
                                            'data-placement="right" title="申请通过" onclick="ensure_project(this);">' +
                                            '<i class="glyphicon glyphicon-ok"></i>' +
                                '</button>' +
                            '</td>');
                }break;

                case 1:{
                    //申请成功，学生还没上传毕设文件
                    $td7=$('<td>申请成功，等待毕设上传</td>');
                    $td8=$('<td><button id="'+ data[i]['project']['projectID'] +'"  onclick="alert('+"'等待学生上传毕设'"+');" type="submit" class="btn btn-small btn-success">' +
                        '<i class="glyphicon glyphicon-ok">等待上传</i></button></td>');
                }break;

                case 2:{
                    //上传毕设成功
                    $td7=$('<td>学生上传毕设成功</td>');
                    $td8=$('<td>' +
                        '<button  id="'+ data[i]['teacherID'] +'/'+ data[i]['project']['designID'] +'/' + data[i]['project']['studentID'] +'/'+'" name="'+ data[i]['project']['fileName']+'" onclick="Start_Download(this)" type="submit" class="btn btn-small btn-warning" ' +
                        ' title="下载提示" data-container="body" data-toggle="popover" data-placement="right" data-content="文件正在下载" >' +
                        '<i class="glyphicon glyphicon-save">下载毕设</i></button></td>');
                }break;

                case 3:{
                    //已完结
                    $td7=$('<td>项目完结</td>');
                    $td8=$('<td>' +
                        '<button  id="'+ data[i]['teacherID'] +'/'+ data[i]['project']['designID'] +'/' +data[i]['project']['studentID'] +'/'+'" name="'+ data[i]['project']['fileName']+'" onclick="Start_Download(this)" type="submit" class="btn btn-small btn-warning" ' +
                        ' title="下载提示" data-container="body" data-toggle="popover" data-placement="right" data-content="文件正在下载" >' +
                        '<i class="glyphicon glyphicon-save">下载毕设</i></button></td>');
                }break;

            }

            $tr.append($td7);
            $tr.append($td8);

            var $td9;
            var $td10;
            if(data[i]['project']['fileName'] == null){
                $td9=$('<td>----</td>');
                $td10=$('<td>----</td>');
            }else{
                $td9=$('<td>'+data[i]['project']['fileName']+'</td>');
                $td10=$('<td>'+times+'</td>');
            }
            $tr.append($td9);
            $tr.append($td10);

            count++;
        }
    }



    <!--老师获取学生申请的毕设-->
    function getStudentApplyProjectInfo() {

        var teacher_ObjJson = Cookies.get('teacher_ObjJson');

        if(teacher_ObjJson!=null){

            $.ajax({
                type:"POST",
                url: "/lvxz/teacher/get_student_project",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                data: teacher_ObjJson,
                async:true,
                success: function (response) {
                    if(response.code == 1){
                        console.log(response);
                        getTable_Info(response.data);
                    } else {
                        alert(response.msg);
                    }
                },
                error: function (data){
                    alert("访问失败，请检查网络、路径......");
                }
            });


        }else{
            alert("关键输入为空！");
        }
    }



    //确定学生通过申请
    function ensure_project(obj) {

        var projectID = obj.id;

        if(projectID.length!=0 ){
            var objJson = {
                "projectID":projectID
            };

            $.ajax({
                type:"POST",
                url: "/lvxz/teacher/ensure_project",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                data: JSON.stringify(objJson),
                async:true,
                success: function (response) {
                    if(response.code == 1){
                        alert(response.msg);

                        $('#table_design').remove();
                        getStudentApplyProjectInfo();//重新加载学生申请毕设
                    } else {
                        alert(response.msg);
                    }
                },
                error: function (data){
                    alert("访问失败，请检查网络、路径......");
                }
            });
        }else{
            alert("提交失败");
        }



    }

    //驳回学生申请
    function oppose_project(obj) {

        var projectID = obj.id;

        if(projectID.length!=0 ){
            var objJson = {
                "projectID":projectID
            };

            $.ajax({
                type:"POST",
                url: "/lvxz/teacher/oppose_project",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                data: JSON.stringify(objJson),
                async:true,
                success: function (response) {
                    if(response.code == 1){
                        alert(response.msg);

                        $('#table_design').remove();
                        getStudentApplyProjectInfo();//重新加载学生申请毕设
                    } else {
                        alert(response.msg);
                    }
                },
                error: function (data){
                    alert("访问失败，请检查网络、路径......");
                }
            });
        }else{
            alert("提交失败");
        }

    }


    //显示留言框
    function showChat(obj){
        var studentID = obj.name;
        $('#studentID').val(studentID);
        data_deal();
    }

    function data_deal(){

        var teacherID = $('#user_id').val(),
            studentID = $('#studentID').val();
        var objJson = {
            "studentID":parseInt(studentID),
            "teacherID":parseInt(teacherID)
        };

        $.ajax({
            type:"POST",
            url: "/lvxz/teacher/get_words",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            data: JSON.stringify(objJson),
            async:true,
            success: function (response) {
                console.log(response);
                if(response.code == 1){
                    showChatWords(response.data);
                } else {
                    alert(response.msg);
                }
            },
            error: function (data){
                alert("访问失败，请检查网络、路径......");
            }
        });
        $('#div_words').remove();
        $('#modal-container-454545').modal('show');
    }

    //处理留言框
    function showChatWords(data){
        var $div=$('<div class="login-box-body" id="div_words"></div>');
        $("bbbb").append($div);

        for(var i=0;i<data.length;i++){

            if(data[i]['flag'] == 1){
                var $label=$('<div style="float:right; text-align:right">' +
                    '<label style="background-color: #337ab7;display: initial">'+data[i]['words']+'</label>' +
                    '</div><br>');
                $div.append($label);
            }else{
                var $label=$('<div style="float:left; text-align:left">' +
                    '<label style="background-color: white;display: initial">'+data[i]['words']+'</label>' +
                    '</div><br>');
                $div.append($label);
            }
        }
    }


    //留言
    function chatWithTeacher() {
        var teacherID = $('#user_id').val(),
            studentID = $('#studentID').val(),
            words = $('#words').val();

        if(words.length!=0){
            var objJson = {
                "studentID":parseInt(studentID),
                "teacherID":parseInt(teacherID),
                "words":words
            };

            $.ajax({
                type:"POST",
                url: "/lvxz/teacher/add_words",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                data: JSON.stringify(objJson),
                async:true,
                success: function (response) {
                    console.log(response);
                    if(response.code == 1){
                        $('#words').val("");
                        data_deal();
                    } else {
                        alert(response.msg);
                    }
                },
                error: function (data){
                    alert("访问失败，请检查网络、路径......");
                }
            });
        }else{
            alert("留言填写未空");
        }
    }


</script>


</html>